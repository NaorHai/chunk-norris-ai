<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chuck Norris AI - Document to Markdown Converter</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- PDF.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- D3.js for graph visualization -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- ForceGraph for advanced network visualization -->
    <script src="https://unpkg.com/force-graph"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: "#e6f1ff",
                            100: "#cce3ff",
                            200: "#99c8ff",
                            300: "#66adff",
                            400: "#3392ff",
                            500: "#0077ff",
                            600: "#005fcc",
                            700: "#004799",
                            800: "#003066",
                            900: "#001833",
                            950: "#000c19"
                        },
                        secondary: {
                            50: "#fff8e6",
                            100: "#fff1cc",
                            200: "#ffe499",
                            300: "#ffd666",
                            400: "#ffc933",
                            500: "#ffbb00",
                            600: "#cc9600",
                            700: "#997000",
                            800: "#664b00",
                            900: "#332500",
                            950: "#191300"
                        },
                        success: {
                            50: "#eafaf2",
                            100: "#d5f6e6",
                            200: "#abeece",
                            300: "#81e5b5",
                            400: "#56dd9d",
                            500: "#2bd484",
                            600: "#22aa6a",
                            700: "#1a7f4f",
                            800: "#115535",
                            900: "#092a1a",
                            950: "#04150d"
                        },
                        dark: "#0a1626",
                        light: "#f8fafc"
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        card: '0 4px 20px -2px rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 8px 30px -2px rgba(0, 0, 0, 0.12)',
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .app-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .split-view {
            flex: 1;
            display: flex;
            min-height: 0;
        }
        .panel {
            flex: 1;
            padding: 15px;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            margin: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .file-preview {
            background-color: #f8f9fa;
        }
        .markdown-preview {
            background-color: #fff;
        }
        .items-left {
            align-items: left;
        }
        #drop-area {
            border: 2px dashed #ccc;
            border-radius: 20px;
            width: 100%;
            padding: 20px;
            text-align: center;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        #drop-area.highlight {
            border-color: #6c757d;
            background-color: #e9ecef;
        }
        header {
            background-color: #0f1d2d;
            color: white;
            padding: 15px 0;
            margin-bottom: 20px;
        }
        .align-left {
            text-align: left;
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        .logo {
            height: 120px;
            width: auto;
            margin-right: 15px;
            position: absolute;
            left:0;
        }
        #file-info {
            margin-top: 15px;
        }
        #file-content img {
            max-width: 100%;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        #markdown-content {
            line-height: 1.6;
            padding: 15px;
            border-radius: 4px;
            background-color: #fff;
        }
        #markdown-content img {
            max-width: 100%;
        }
        #markdown-content pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        #markdown-content code {
            background-color: #f5f5f5;
            padding: 2px 4px;
            border-radius: 3px;
        }
        #markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 15px;
        }
        #markdown-content th, #markdown-content td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        #markdown-content th {
            background-color: #f2f2f2;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-info-card {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 20px;
            margin-bottom: 20px;
            background-color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            text-align: center;
        }
        .file-content-preview {
            margin-top: 15px;
            max-height: 650px;
            overflow: auto;
        }
        .pdf-preview, .docx-preview, .rtf-preview, .text-preview {
            font-family: monospace;
            white-space: pre-wrap;
            background-color: white;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            height: 1000px;
            overflow: auto;
            iframe {
                height: 800px;
            }
        }
        .file-icon {
            font-size: 48px;
            margin-bottom: 15px;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px auto;
        }
        .pdf-icon { 
            color: #e74c3c; 
            background-color: rgba(231, 76, 60, 0.1);
        }
        .doc-icon { 
            color: #3498db; 
            background-color: rgba(52, 152, 219, 0.1);
        }
        .img-icon { 
            color: #2ecc71; 
            background-color: rgba(46, 204, 113, 0.1);
        }
        .text-icon { 
            color: #95a5a6; 
            background-color: rgba(149, 165, 166, 0.1);
        }
        #pdf-container {
            width: 100%;
            border-radius: 4px;
            background-color: #fff;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 620px;
        }
        #pdf-viewer {
            width: 100%;
            height: 500px;
            border: 1px solid #dee2e6;
            background-color: #fff;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
            border-radius: 4px;
        }
        .pdf-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .pdf-controls button {
            margin: 0 5px;
            border-radius: 20px;
            padding: 5px 15px;
            transition: all 0.2s ease;
        }
        .pdf-controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        #page-info {
            margin: 0 10px;
            font-weight: 500;
            color: #495057;
        }
        .panel-header {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            color: #495057;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-type-badge {
            background-color: #f8f9fa;
            border-radius: 15px;
            padding: 3px 10px;
            font-size: 14px;
            color: #495057;
            margin-bottom: 10px;
            display: inline-block;
        }
        .zoom-controls {
            display: flex;
            align-items: center;
            margin-left: 10px;
        }
        .zoom-button {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #6c757d;
            margin: 0 5px;
        }
        .zoom-button:hover {
            color: #343a40;
        }
        .btn-tool {
            padding: 5px 10px;
            margin: 0 5px;
            border-radius: 20px;
        }
        .markdown-toggle {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }
        /* Chuck Norris Loading Animation */
        .chuck-norris-loader {
            width: 150px;
            height: 150px;
            margin: 20px auto;
            display: none;
            position: relative;
        }

        .chuck-norris-loader img {
            width: 100%;
            height: 100%;
            animation: pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); filter: brightness(0.9) drop-shadow(0 0 3px #ff9900); }
            100% { transform: scale(1.1); filter: brightness(1.1) drop-shadow(0 0 8px #3498db); }
        }
        
        /* Chuck Norris AI PRO popup styles */
        .chuck-norris-pro-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 400px;
            text-align: center;
            border: 3px solid #ffbb00;
            display: none;
        }
        
        .chuck-norris-pro-popup h3 {
            margin-top: 0;
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }
        
        .chuck-norris-pro-popup p {
            font-size: 18px;
            margin: 15px 0;
        }
        
        .chuck-norris-pro-close {
            background-color: #ffbb00;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-top: 15px;
        }
        
        .chuck-norris-pro-close:hover {
            background-color: #e6a800;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        
        /* Memory Graph styles */
        #memory-graph-container {
            width: 100%;
            height: 600px;
            background-color: #1a1a2e;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .memory-graph-panel {
            flex: 1;
            padding: 15px;
            margin: 10px;
            border-radius: 0.5rem;
            background-color: #f8f9fa;
            overflow: hidden;
            display: none; /* Hidden by default */
        }
        
        .graph-node {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .graph-node:hover {
            stroke: #fff;
            stroke-width: 2px;
        }
        
        .graph-link {
            stroke-opacity: 0.6;
            transition: all 0.2s ease;
        }
        
        .graph-link:hover {
            stroke-opacity: 1;
            stroke-width: 2px;
        }
        
        .node-label {
            font-size: 12px;
            pointer-events: none;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .graph-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .graph-control-btn {
            background-color: rgba(255,255,255,0.15);
            color: white;
            border: none;
            border-radius: 4px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .graph-control-btn:hover {
            background-color: rgba(255,255,255,0.25);
        }
        
        .node-info-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 100;
        }
        
        .node-info-panel.visible {
            transform: translateY(0);
        }
        
        /* Graph Legend */
        .graph-legend {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0,0,0,0.7);
            border-radius: 4px;
            padding: 10px;
            color: white;
            font-size: 12px;
            z-index: 100;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-sans">
    <header class="bg-gradient-to-r from-primary-700 via-primary-800 to-dark text-white py-5 shadow-lg">
        <div class="container mx-auto px-4 flex items-center relative">
            <img src="/static/images/logo.png" alt="Document Converter Logo" class="h-24 absolute left-0 top-1/2 -translate-y-1/2">
            <div class="text-center w-full">
                <h1 class="text-3xl font-bold mb-1">Document to Markdown Converter</h1>
                <p class="text-gray-100">Upload a document (PDF, DOCX, RTF, images) and see the markdown conversion</p>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 flex-1 flex flex-col py-8 max-w-6xl">
        <div class="mb-8">
            <div class="w-full">
                <div id="drop-area" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center bg-white transition-all hover:bg-gray-50 hover:border-primary-400 shadow-card hover:shadow-card-hover">
                    <form id="upload-form" class="my-3" enctype="multipart/form-data">
                        <p class="mb-4 text-gray-600">Drag & drop files here or click to select files</p>
                        <input type="file" id="file-input" name="file" accept=".pdf,.docx,.doc,.rtf,.png,.jpg,.jpeg,.txt" class="hidden">
                        <label for="file-input" class="bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-8 rounded-full shadow-md transition-all transform hover:scale-105 hover:-translate-y-0.5 duration-300 cursor-pointer inline-block focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50">
                            Select a File
                        </label>
                        
                        <!-- Mode selection radio buttons -->
                        <div class="mt-8 text-left">
                            <h4 class="font-medium text-gray-700 mb-3">Processing Mode:</h4>
                            
                            <!-- AI Refinement radio button -->
                            <div class="mb-4">
                                <div class="flex items-start">
                                    <input class="w-5 h-5 text-primary-500 focus:ring-primary-400" type="radio" id="use-ai-refinement" name="processing-mode" value="ai-refinement" checked>
                                    <label class="ml-2 text-gray-700 font-medium" for="use-ai-refinement">
                                        Use Tesseract (OCR) & AI
                                    </label>
                                </div>
                                <p class="text-sm text-gray-500 mt-1 ml-7 align-left">
                                    Use Tesseract for text extraction and OpenAI's GPT-4o Mini to improve document structure and correct formatting inconsistencies.
                                </p>
                            </div>
                            
                            <!-- Chuck Norris AI radio button -->
                            <div class="mb-4">
                                <div class="flex items-start">
                                    <input class="w-5 h-5 text-secondary-500 focus:ring-secondary-400" type="radio" id="use-chuck-norris-ai" name="processing-mode" value="chuck-norris-ai">
                                    <label class="ml-2 text-gray-700" for="use-chuck-norris-ai">
                                        <span class="font-semibold flex items-center">
                                            Chunk Norris AI
                                            <span class="inline-flex ml-2 bg-secondary-500 text-white rounded-full h-6 w-6 items-center justify-center">ðŸ’ª</span>
                                        </span>
                                    </label>
                                </div>
                                <p class="text-sm text-gray-500 mt-1 ml-7 align-left">
                                    Bypass OCR completely and let AI directly interpret the image content. For images with complex layouts or when OCR is struggling.
                                </p>
                            </div>
                            
                            <!-- Chuck Norris AI PRO radio button -->
                            <div class="mb-4">
                                <div class="flex items-start">
                                    <input class="w-5 h-5 text-red-500 focus:ring-red-400" type="radio" id="use-chuck-norris-ai-pro" name="processing-mode" value="chuck-norris-ai-pro">
                                    <label class="ml-2 text-gray-700" for="use-chuck-norris-ai-pro">
                                        <span class="font-semibold flex items-center">
                                            Chunk Norris AI PRO
                                            <span class="inline-flex ml-2 bg-red-500 text-white rounded-full px-2 text-xs font-bold">PRO</span>
                                        </span>
                                    </label>
                                </div>
                                <p class="text-sm text-gray-500 mt-1 ml-7 align-left">
                                    Activate ultimate power mode for even more accurate document transformations.
                                </p>
                            </div>
                            
                            <!-- Memory Graph Toggle (Added here) -->
                            <div class="mb-4 border-t border-gray-200 pt-4 mt-6">
                                <h4 class="font-medium text-gray-700 mb-3">Additional Features:</h4>
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="memory-graph-toggle" class="w-5 h-5 text-primary-600 rounded border-gray-300 focus:ring-primary-500">
                                    <label for="memory-graph-toggle" class="text-gray-700 font-medium">
                                        Generate Memory Graph
                                        <span class="inline-flex ml-2 bg-primary-500 text-white rounded-full px-2 text-xs font-bold">NEW</span>
                                    </label>
                                </div>
                                <p class="text-sm text-gray-500 mt-1 ml-7 align-left">
                                    Create an interactive visualization of the document's structure and relationships. Explore connections between concepts, sections, and entities.
                                </p>
                                
                                <!-- Ontology Graph Toggle -->
                                <div class="flex items-center space-x-2 mt-3">
                                    <input type="checkbox" id="ontology-graph-toggle" class="w-5 h-5 text-primary-600 rounded border-gray-300 focus:ring-primary-500">
                                    <label for="ontology-graph-toggle" class="text-gray-700 font-medium">
                                        Generate Ontology Graph
                                        <span class="inline-flex ml-2 bg-green-500 text-white rounded-full px-2 text-xs font-bold">NEW</span>
                                    </label>
                                </div>
                                <p class="text-sm text-gray-500 mt-1 ml-7 align-left">
                                    Create an ontology graph using FalkorDB's GraphRAG-SDK. Visualize entities, properties, and relationships in the document content.
                                </p>
                            </div>
                        </div>
                    </form>
                    <div id="file-info" class="hidden mt-6">
                        <p class="bg-gray-50 inline-block px-4 py-2 rounded-lg"><strong>Selected File:</strong> <span id="file-name" class="font-medium"></span></p>
                    </div>
                    <div id="processing-time" class="hidden mt-2">
                        <p class="bg-green-50 text-green-700 inline-block px-4 py-2 rounded-lg">
                            <i class="fas fa-clock mr-2"></i>
                            <span id="processing-time-value"></span>
                        </p>
                    </div>
                    <div class="loader hidden w-12 h-12 border-4 border-gray-200 border-t-primary-500 rounded-full animate-spin mx-auto mt-6" id="loader"></div>
                    <div class="chuck-norris-loader" id="chuck-norris-loader">
                        <img src="/static/images/chuck_norris_loading.svg" alt="Chuck Norris AI loading">
                    </div>
                </div>
            </div>
        </div>

        <!-- Document Summary Section -->
        <div id="document-summary-panel" class="mb-6 bg-white rounded-xl shadow-card p-5 overflow-hidden border border-gray-100">
            <div class="border-b border-gray-100 pb-3 mb-5 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Document Summary</h3>
                <div class="flex items-center">
                    <button id="refresh-summary" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors" title="Refresh Summary">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            <div id="document-summary-content" class="prose prose-primary max-w-none">
                <div class="flex flex-col justify-center items-center h-full">
                    <div class="w-16 h-16 bg-primary-700 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-file-alt text-white text-2xl"></i>
                    </div>
                    <p class="text-gray-600 text-lg font-medium mb-2">Document Summary</p>
                    <p class="text-gray-400 text-center max-w-md px-4">
                        A concise summary of the document will appear here after processing.
                    </p>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col md:flex-row gap-6 min-h-0">
            <div class="w-full md:w-1/2 bg-white rounded-xl shadow-card p-5 overflow-auto border border-gray-100">
                <div class="border-b border-gray-100 pb-3 mb-5 flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Original File</h3>
                    <div id="original-file-tools"></div>
                </div>
                <div id="file-content" class="overflow-auto">
                    <p class="text-gray-500 text-center py-10">File preview will appear here after uploading.</p>
                </div>
            </div>
            <div id="markdown-output-container" class="w-full md:w-1/2 bg-white rounded-xl shadow-card p-5 overflow-auto border border-gray-100">
                <div class="border-b border-gray-100 pb-3 mb-5 flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-gray-800">Markdown Output</h3>
                    <div id="markdown-tools" class="flex items-center">
                        <div class="mr-3">
                            <div class="flex items-center">
                                <div class="relative inline-block w-12 h-6 transition duration-200 ease-in-out rounded-full cursor-pointer">
                                    <input 
                                        type="checkbox" 
                                        id="show-rendered" 
                                        class="absolute w-6 h-6 transition-all duration-200 ease-in-out bg-white border-2 border-gray-200 rounded-full appearance-none cursor-pointer peer checked:right-0 right-6 checked:border-primary-500 z-10"
                                        checked
                                    />
                                    <label 
                                        for="show-rendered" 
                                        class="block h-full bg-gray-200 peer-checked:bg-primary-100 rounded-full"
                                    ></label>
                                </div>
                                <label class="ml-2 text-sm text-gray-600" for="show-rendered">
                                    Show rendered
                                </label>
                            </div>
                        </div>
                        <button id="copy-markdown" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors" title="Copy to Clipboard">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                </div>
                <div id="markdown-content" class="markdown prose prose-primary max-w-none">
                    <p class="text-gray-500 text-center py-10">Markdown output will appear here after uploading a file.</p>
                </div>
            </div>
        </div>

        <!-- Memory Graph Panel (initially hidden) -->
        <div id="memory-graph-panel" class="mt-6 bg-white rounded-xl shadow-card p-5 overflow-hidden border border-gray-100 hidden">
            <div class="border-b border-gray-100 pb-3 mb-5 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Memory Graph</h3>
                <div class="flex items-center">
                    <button id="zoom-in" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors mr-2" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button id="zoom-out" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors mr-2" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button id="center-graph" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors" title="Center Graph">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                </div>
            </div>
            <div id="memory-graph-container" class="h-[600px] bg-[#1a1a2e] rounded-lg relative">
                <div class="flex flex-col justify-center items-center h-full">
                    <div class="w-16 h-16 bg-primary-700 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-project-diagram text-white text-2xl"></i>
                    </div>
                    <p class="text-white text-lg font-medium mb-2">Memory Graph Visualization</p>
                    <p class="text-gray-400 text-center max-w-md px-4">
                        Process a document and enable the Memory Graph feature to visualize document structure,
                        connections between concepts, and the overall flow of information.
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Ontology Graph Panel (initially hidden) -->
        <div id="ontology-graph-panel" class="mt-6 bg-white rounded-xl shadow-card p-5 overflow-hidden border border-gray-100 hidden">
            <div class="border-b border-gray-100 pb-3 mb-5 flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">Ontology Graph</h3>
                <div class="flex items-center">
                    <button id="ontology-zoom-in" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors mr-2" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button id="ontology-zoom-out" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors mr-2" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button id="ontology-center-graph" class="text-sm px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors" title="Center Graph">
                        <i class="fas fa-compress-arrows-alt"></i>
                    </button>
                </div>
            </div>
            <div id="ontology-graph-container" class="h-[600px] bg-[#1a1a2e] rounded-lg relative">
                <div class="flex flex-col justify-center items-center h-full">
                    <div class="w-16 h-16 bg-green-700 rounded-full flex items-center justify-center mb-4">
                        <i class="fas fa-sitemap text-white text-2xl"></i>
                    </div>
                    <p class="text-white text-lg font-medium mb-2">Ontology Graph Visualization</p>
                    <p class="text-gray-400 text-center max-w-md px-4">
                        Process a document and enable the Ontology Graph feature to visualize entities, properties, 
                        and relationships using FalkorDB's GraphRAG-SDK.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Get DOM elements
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const fileInputLabel = document.querySelector('label[for="file-input"]');
        const uploadForm = document.getElementById('upload-form');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileContent = document.getElementById('file-content');
        const markdownContent = document.getElementById('markdown-content');
        const loader = document.getElementById('loader');
        const chuckNorrisLoader = document.getElementById('chuck-norris-loader');
        const copyMarkdownBtn = document.getElementById('copy-markdown');
        const showRenderedToggle = document.getElementById('show-rendered');
        const memoryGraphToggle = document.getElementById('memory-graph-toggle');
        const ontologyGraphToggle = document.getElementById('ontology-graph-toggle');
        
        // Current PDF state
        let currentPdfDoc = null;
        let currentPage = 1;
        let totalPages = 0;
        let currentScale = 1.5;
        
        // Store the raw markdown
        let rawMarkdown = '';

        // Add event listeners for radio button changes
        document.querySelectorAll('input[name="processing-mode"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // If we're currently loading, switch loaders based on the selected mode
                if (loader.classList.contains('block') || chuckNorrisLoader.style.display === 'block') {
                    if (this.id === 'use-chuck-norris-ai' || this.id === 'use-chuck-norris-ai-pro') {
                        loader.classList.remove('block');
                        loader.classList.add('hidden');
                        chuckNorrisLoader.style.display = 'block';
                    } else {
                        loader.classList.remove('hidden');
                        loader.classList.add('block');
                        chuckNorrisLoader.style.display = 'none';
                    }
                }
                
                // Special handling for Chuck Norris AI PRO
                if (this.id === 'use-chuck-norris-ai-pro') {
                    // Show popup message
                    document.getElementById('pro-overlay').style.display = 'block';
                    document.getElementById('chuck-norris-pro-popup').style.display = 'block';
                    
                    // Switch to regular Chuck Norris AI since Chuck Norris doesn't need Pro Mode
                    setTimeout(() => {
                        document.getElementById('use-chuck-norris-ai').checked = true;
                    }, 100);
                }
            });
        });
        
        // Close popup when button is clicked
        function closeProPopup() {
            document.getElementById('pro-overlay').style.display = 'none';
            document.getElementById('chuck-norris-pro-popup').style.display = 'none';
        }
        
        // Also close popup when clicking on overlay
        const proOverlay = document.getElementById('pro-overlay');
        if (proOverlay) {
            proOverlay.addEventListener('click', function() {
                document.getElementById('pro-overlay').style.display = 'none';
                document.getElementById('chuck-norris-pro-popup').style.display = 'none';
            });
        }

        // Toggle between raw and rendered markdown
        showRenderedToggle.addEventListener('change', function() {
            if (this.checked) {
                // Show rendered markdown
                markdownContent.innerHTML = marked.parse(rawMarkdown);
            } else {
                // Show raw markdown
                markdownContent.innerHTML = `<pre class="whitespace-pre-wrap text-sm font-mono bg-gray-50 p-4 rounded">${rawMarkdown}</pre>`;
            }
        });

        // Copy markdown to clipboard
        copyMarkdownBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(rawMarkdown).then(() => {
                const originalText = copyMarkdownBtn.innerHTML;
                copyMarkdownBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Copied!';
                setTimeout(() => {
                    copyMarkdownBtn.innerHTML = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Error copying text: ', err);
            });
        });

        // Prevent defaults for drag events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Highlight drop area when file is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight() {
            dropArea.classList.add('bg-gray-50');
            dropArea.classList.add('border-primary-500');
            dropArea.classList.add('shadow-card-hover');
        }

        function unhighlight() {
            dropArea.classList.remove('bg-gray-50');
            dropArea.classList.remove('border-primary-500');
            dropArea.classList.remove('shadow-card-hover');
        }

        // Handle dropped files
        dropArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length) {
                handleFiles(files);
            }
        }

        // The label already has a 'for' attribute that triggers the file input
        // So we don't need to manually trigger the click
        fileInput.addEventListener('change', function(e) {
            console.log('File input changed', this.files);
            if (this.files && this.files.length) {
                handleFiles(this.files);
            }
        });

        function handleFiles(files) {
            console.log('Handling files:', files);
            const file = files[0]; // Only handle the first file
            console.log('Selected file:', file.name, file.type, file.size);
            
            fileName.textContent = file.name;
            fileInfo.classList.remove('hidden');
            
            // Show appropriate loading indicator
            if (document.getElementById('use-chuck-norris-ai').checked) {
                chuckNorrisLoader.style.display = 'block';
            } else {
                loader.classList.remove('hidden');
                loader.classList.add('block');
            }
            
            // Clear previous content
            fileContent.innerHTML = '<p class="text-gray-500">Processing file...</p>';
            markdownContent.innerHTML = '<p class="text-gray-500">Converting to markdown...</p>';
            
            // Preview the file based on its type
            previewFile(file);
            
            // Get the processing mode
            const useAiRefinement = document.getElementById('use-ai-refinement').checked;
            const useChuckNorrisAi = document.getElementById('use-chuck-norris-ai').checked;
            const generateMemoryGraph = memoryGraphToggle && memoryGraphToggle.checked;
            const generateOntologyGraph = ontologyGraphToggle && ontologyGraphToggle.checked;
            
            // After file upload starts, disable the memory graph toggle
            if (memoryGraphToggle) {
                memoryGraphToggle.disabled = true;
                // Add a visual cue that it's disabled
                const memoryGraphLabel = document.querySelector('label[for="memory-graph-toggle"]');
                if (memoryGraphLabel) {
                    memoryGraphLabel.classList.add('opacity-60');
                }
            }
            
            // After file upload starts, disable the ontology graph toggle
            if (ontologyGraphToggle) {
                ontologyGraphToggle.disabled = true;
                // Add a visual cue that it's disabled
                const ontologyGraphLabel = document.querySelector('label[for="ontology-graph-toggle"]');
                if (ontologyGraphLabel) {
                    ontologyGraphLabel.classList.add('opacity-60');
                }
            }
            
            console.log('Use AI refinement:', useAiRefinement);
            console.log('Use Chuck Norris AI:', useChuckNorrisAi);
            console.log('Generate memory graph:', generateMemoryGraph);
            console.log('Generate ontology graph:', generateOntologyGraph);
            
            // Add parameters to the form data
            const formData = new FormData();
            formData.append('file', file);
            formData.append('use_ai_refinement', useAiRefinement);
            formData.append('use_chuck_norris_ai', useChuckNorrisAi);
            formData.append('generate_memory_graph', generateMemoryGraph);
            formData.append('generate_ontology_graph', generateOntologyGraph);
            
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Hide loading indicators
                loader.classList.remove('block');
                loader.classList.add('hidden');
                chuckNorrisLoader.style.display = 'none';
                
                if (data.success) {
                    // Show processing time
                    const processingTimeDiv = document.getElementById('processing-time');
                    const processingTimeValue = document.getElementById('processing-time-value');
                    processingTimeDiv.classList.remove('hidden');
                    processingTimeValue.textContent = `Processing completed in ${data.processing_time} seconds`;
                    
                    // Display the markdown content
                    displayMarkdown(data.markdown);
                    
                    // Handle memory graph if enabled and data is present
                    if (generateMemoryGraph && data.memory_graph && data.memory_graph.nodes && data.memory_graph.nodes.length > 0) {
                        // Show memory graph panel
                        const memoryGraphPanel = document.getElementById('memory-graph-panel');
                        memoryGraphPanel.classList.remove('hidden');
                        
                        // Process the memory graph data
                        const graphData = processGraphData(data.memory_graph);
                        
                        // Render the memory graph
                        renderMemoryGraph(graphData);
                        
                        // Scroll to the memory graph after a short delay
                        setTimeout(() => {
                            memoryGraphPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 500);
                    }
                    
                    // Handle ontology graph if enabled and data is present
                    if (generateOntologyGraph && data.ontology_graph && data.ontology_graph.nodes && data.ontology_graph.nodes.length > 0) {
                        // Show ontology graph panel
                        const ontologyGraphPanel = document.getElementById('ontology-graph-panel');
                        ontologyGraphPanel.classList.remove('hidden');
                        
                        // Process the ontology graph data
                        const graphData = processGraphData(data.ontology_graph);
                        
                        // Render the ontology graph
                        renderOntologyGraph(graphData);
                        
                        // Scroll to the ontology graph after a short delay if memory graph is not present
                        if (!generateMemoryGraph || !data.memory_graph || !data.memory_graph.nodes || data.memory_graph.nodes.length === 0) {
                            setTimeout(() => {
                                ontologyGraphPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            }, 500);
                        }
                    }
                    
                    // For image files, update the src to the server path if needed
                    if (data.imagePath) {
                        updateImagePathsInMarkdown(data.imagePath);
                    }
                    
                    // Handle document summary if present
                    if (data.document_summary) {
                        displayDocumentSummary(data.document_summary);
                    }
                } else {
                    // Show error
                    markdownContent.innerHTML = `
                        <div class="bg-red-50 text-red-600 p-4 rounded-lg border border-red-100">
                            <p class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i> Error</p>
                            <p class="text-sm mt-2">${data.error || 'Unknown error'}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                loader.classList.remove('block');
                loader.classList.add('hidden');
                chuckNorrisLoader.style.display = 'none';
                markdownContent.innerHTML = `
                    <div class="bg-red-50 text-red-600 p-4 rounded-lg border border-red-100">
                        <p class="flex items-center"><i class="fas fa-exclamation-circle mr-2"></i> Error</p>
                        <p class="text-sm mt-2">${error.message}</p>
                    </div>
                `;
            });
        }

        function updateImagePathsInMarkdown(serverPath) {
            // This function can be used to update image paths in markdown if needed
        }

        // Add the missing formatFileSize function
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Add the missing getFileTypeFromName function
        function getFileTypeFromName(filename) {
            const extension = filename.split('.').pop().toLowerCase();
            const typeMap = {
                'pdf': 'application/pdf',
                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'doc': 'application/msword',
                'rtf': 'application/rtf',
                'png': 'image/png',
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'txt': 'text/plain'
            };
            return typeMap[extension] || 'application/octet-stream';
        }

        // Add function to generate ontology graph from markdown content via the API
        function generateOntologyGraph(markdownContent) {
            // Show loading message
            document.getElementById('ontology-graph-container').innerHTML = `
                <div class="flex flex-col justify-center items-center h-full">
                    <div class="w-16 h-16 bg-green-700 rounded-full flex items-center justify-center mb-4 animate-pulse">
                        <i class="fas fa-sitemap text-white text-2xl"></i>
                    </div>
                    <p class="text-white text-lg font-medium mb-2">Generating Ontology Graph...</p>
                    <p class="text-gray-400 text-center max-w-md px-4">Creating an interactive visualization of entities, properties, and relationships in the document content...</p>
                </div>
            `;
            
            // Call the backend API to generate the ontology graph
            fetch('/generate_ontology_graph', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    markdown: markdownContent
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.ontology_graph && 
                    data.ontology_graph.nodes && data.ontology_graph.nodes.length > 0) {
                    // Clear the container
                    document.getElementById('ontology-graph-container').innerHTML = '';
                    
                    // Process the ontology graph data
                    const graphData = processGraphData(data.ontology_graph);
                    
                    // Render the ontology graph
                    renderOntologyGraph(graphData);
                } else {
                    // Show a more informative message when no meaningful graph could be generated
                    document.getElementById('ontology-graph-container').innerHTML = `
                        <div class="flex flex-col justify-center items-center h-full">
                            <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center mb-4">
                                <i class="fas fa-info-circle text-white text-2xl"></i>
                            </div>
                            <p class="text-white text-lg font-medium mb-2">No Ontology Structure Detected</p>
                            <p class="text-gray-400 text-center max-w-md px-4">
                                The document doesn't contain enough structured entities to generate a meaningful ontology graph.
                                Try a document with more entities and defined relationships.
                            </p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error generating ontology graph:', error);
                // Show a user-friendly error with retry option
                document.getElementById('ontology-graph-container').innerHTML = `
                    <div class="flex flex-col justify-center items-center h-full">
                        <div class="w-16 h-16 bg-red-800 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                        </div>
                        <p class="text-white text-lg font-medium mb-2">Error Generating Ontology Graph</p>
                        <p class="text-gray-400 text-center max-w-md px-4 mb-4">
                            We encountered a problem while analyzing the document entities. 
                            The server might be busy or the document is too complex.
                        </p>
                        <button id="retry-ontology-graph" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">
                            <i class="fas fa-redo mr-2"></i> Try Again
                        </button>
                    </div>
                `;
                
                // Add event listener to the retry button
                document.getElementById('retry-ontology-graph')?.addEventListener('click', () => {
                    generateOntologyGraph(markdownContent);
                });
            });
        }

        // Render the ontology graph using Force Graph
        function renderOntologyGraph(graphData) {
            const container = document.getElementById('ontology-graph-container');
            const width = container.clientWidth;
            const height = 600;
            
            // Clear any existing graph
            container.innerHTML = '';
            
            // Create SVG container
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Create simulation
            const simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(50));
            
            // Create links
            const link = svg.append('g')
                .selectAll('line')
                .data(graphData.links)
                .enter()
                .append('line')
                .attr('stroke', '#fff')
                .attr('stroke-opacity', 0.8)
                .attr('stroke-width', 2)
                .attr('marker-end', 'url(#arrowhead)');
            
            // Add arrowhead marker definition
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 15)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('xoverflow', 'visible')
                .append('svg:path')
                .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                .attr('fill', '#fff');
            
            // Add edge type labels
            const edgeLabels = svg.append('g')
                .selectAll('text')
                .data(graphData.links)
                .enter()
                .append('text')
                .text(d => d.type)
                .attr('font-size', 10)
                .attr('fill', '#fff')
                .attr('text-shadow', '0 1px 3px rgba(0,0,0,0.3)');
            
            // Create nodes
            const node = svg.append('g')
                .selectAll('circle')
                .data(graphData.nodes)
                .enter()
                .append('circle')
                .attr('r', 10)
                .attr('fill', d => {
                    switch(d.type) {
                        case 'Migration': return '#2196F3';
                        case 'CloudEnvironment': return '#4CAF50';
                        case 'Application': return '#FFC107';
                        case 'Data': return '#9C27B0';
                        case 'Practice': return '#607D8B';
                        default: return '#999';
                    }
                })
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));
            
            // Add labels
            const label = svg.append('g')
                .selectAll('text')
                .data(graphData.nodes)
                .enter()
                .append('text')
                .text(d => d.name)
                .attr('font-size', 12)
                .attr('dx', 15)
                .attr('dy', 4)
                .attr('fill', '#fff')
                .attr('text-shadow', '0 1px 3px rgba(0,0,0,0.3)');
            
            // Add tooltips
            node.append('title')
                .text(d => {
                    const props = Object.entries(d.properties)
                        .map(([key, value]) => `${key}: ${value}`)
                        .join('\n');
                    return `${d.type}\n${props}`;
                });
            
            // Update positions on each tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
                
                // Update edge label positions
                edgeLabels
                    .attr('x', d => (d.source.x + d.target.x) / 2)
                    .attr('y', d => (d.source.y + d.target.y) / 2);
            });
            
            // Drag functions
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }

        // Add the displayMarkdown function
        function displayMarkdown(markdown) {
            // Store the raw markdown
            rawMarkdown = markdown;
            
            // Update the markdown content based on the show-rendered toggle
            if (document.getElementById('show-rendered').checked) {
                // Show rendered markdown
                markdownContent.innerHTML = marked.parse(markdown);
            } else {
                // Show raw markdown
                markdownContent.innerHTML = `<pre class="whitespace-pre-wrap text-sm font-mono bg-gray-50 p-4 rounded">${markdown}</pre>`;
            }
        }

        // Add file preview function
        function previewFile(file) {
            const fileType = file.type;
            const reader = new FileReader();
            
            if (fileType === 'application/pdf') {
                // Preview PDF
                const objectUrl = URL.createObjectURL(file);
                fileContent.innerHTML = `
                    <div class="pdf-preview">
                        <iframe src="${objectUrl}" width="100%" height="600px" frameborder="0"></iframe>
                    </div>
                `;
            } else if (fileType.startsWith('image/')) {
                // Preview image
                reader.onload = function(e) {
                    fileContent.innerHTML = `
                        <div class="text-center">
                            <img src="${e.target.result}" alt="Preview" class="max-w-full h-auto rounded-lg shadow-lg">
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else if (fileType === 'text/plain' || 
                      fileType === 'application/rtf' || 
                      fileType === 'application/msword' || 
                      fileType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                // Preview text-based files
                reader.onload = function(e) {
                    fileContent.innerHTML = `
                        <div class="text-preview">
                            <pre class="whitespace-pre-wrap text-sm font-mono bg-gray-50 p-4 rounded">${e.target.result}</pre>
                        </div>
                    `;
                };
                reader.readAsText(file);
            } else {
                // Unsupported file type
                fileContent.innerHTML = `
                    <div class="text-center p-4">
                        <i class="fas fa-file text-4xl text-gray-400 mb-2"></i>
                        <p class="text-gray-500">Preview not available for this file type</p>
                    </div>
                `;
            }
        }

        function processGraphData(graphData) {
            // Initialize nodes and links arrays
            const nodes = [];
            const links = [];
            const nodeMap = new Map(); // Add a map to track existing nodes
            
            // Process nodes
            if (graphData.nodes) {
                graphData.nodes.forEach((node) => {
                    // Match the exact backend structure
                    const nodeObj = {
                        id: node.id,
                        name: node.title, // Use title as the display name
                        type: node.type,
                        summary: node.summary,
                        properties: {
                            title: node.title,
                            summary: node.summary,
                            parent: node.parent // Include parent if it exists
                        }
                    };
                    
                    nodes.push(nodeObj);
                    nodeMap.set(node.id, nodeObj);
                });
            }
            
            // Process edges
            if (graphData.edges) {
                graphData.edges.forEach((edge) => {
                    // Match the exact backend structure
                    if (edge.source && edge.target && nodeMap.has(edge.source) && nodeMap.has(edge.target)) {
                        links.push({
                            source: edge.source,
                            target: edge.target,
                            type: edge.relation, // Use relation as the type
                            properties: {
                                relation: edge.relation
                            }
                        });
                    } else {
                        console.warn(`Skipping edge: Invalid source or target node`);
                    }
                });
            }
            
            // If no edges exist, create hierarchical relationships based on node types and parent relationships
            if (links.length === 0 && nodes.length > 0) {
                nodes.forEach(node => {
                    // If node has a parent, create a relationship
                    if (node.properties.parent && nodeMap.has(node.properties.parent)) {
                        links.push({
                            source: node.id,
                            target: node.properties.parent,
                            type: 'is_part_of',
                            properties: {
                                relation: 'is_part_of'
                            }
                        });
                    }
                });
            }
            
            console.log('Processed graph data:', { nodes, links });
            return { nodes, links };
        }

        function renderMemoryGraph(graphData) {
            const graphContainer = document.getElementById('memory-graph-container');
            
            // Validate graph data
            if (!graphData || !Array.isArray(graphData.nodes) || !Array.isArray(graphData.links)) {
                console.error('Invalid graph data structure:', graphData);
                graphContainer.innerHTML = `
                    <div class="flex flex-col justify-center items-center h-full">
                        <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                        </div>
                        <p class="text-white text-lg font-medium mb-2">Error Loading Graph</p>
                        <p class="text-gray-400 text-center max-w-md px-4">
                            The graph data structure is invalid or empty. Please try processing the document again.
                        </p>
                    </div>
                `;
                return;
            }

            try {
                // Initialize the graph with specific colors for memory elements
                let memoryGraph = ForceGraph()
                    .graphData(graphData)
                    .backgroundColor('#1a1a2e')
                    .nodeId('id')
                    .nodeLabel(node => {
                        // Create a rich label with name and type
                        const name = node.name || node.label || node.id || 'Unnamed Node';
                        const type = node.type ? ` (${node.type})` : '';
                        return `${name}${type}`;
                    })
                    .nodeColor(node => {
                        // Use different colors based on node type
                        switch (node.type?.toLowerCase()) {
                            case 'section':
                                return '#2196F3';  // Blue for sections
                            case 'process':
                                return '#4CAF50';  // Green for processes
                            case 'entity':
                                return '#FFC107';  // Amber for entities
                            case 'concept':
                                return '#9C27B0';  // Purple for concepts
                            default:
                                return '#607D8B';  // Blue-grey for others
                        }
                    })
                    .nodeVal(node => {
                        // Set node size based on type
                        switch (node.type?.toLowerCase()) {
                            case 'section':
                                return 20;  // Larger for sections
                            case 'process':
                            case 'entity':
                                return 15;  // Medium for processes and entities
                            default:
                                return 10;  // Default size
                        }
                    })
                    .d3AlphaDecay(0.02)
                    .d3VelocityDecay(0.2)
                    .d3Force('link', d3.forceLink().id(d => d.id).distance(100).strength(0.3))
                    .d3Force('charge', d3.forceManyBody().strength(-200))
                    .d3Force('center', d3.forceCenter())
                    .linkColor(() => '#ffffff')
                    .linkDirectionalArrowLength(8)
                    .linkDirectionalArrowRelPos(1)
                    .linkDirectionalParticles(0)
                    .linkWidth(1)
                    .linkLabel(link => {
                        // Create a rich label for the link
                        const type = link.type || link.label || 'Related to';
                        const properties = link.properties || {};
                        const propsStr = Object.entries(properties)
                            .map(([key, value]) => `${key}: ${value}`)
                            .join(', ');
                        return propsStr ? `${type} (${propsStr})` : type;
                    })
                    .linkCanvasObject((link, ctx, globalScale) => {
                        // Force white color for links
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(link.source.x, link.source.y);
                        ctx.lineTo(link.target.x, link.target.y);
                        ctx.stroke();
                    })
                    .nodeCanvasObject((node, ctx, globalScale) => {
                        try {
                            // Node circle
                            ctx.beginPath();
                            ctx.arc(node.x || 0, node.y || 0, node.val || 10, 0, 2 * Math.PI);
                            ctx.fillStyle = node.color || '#607D8B';
                            ctx.fill();
                            
                            // Node border
                            ctx.strokeStyle = '#ffffff';
                            ctx.lineWidth = 1;
                            ctx.stroke();
                            
                            // Node label if zoomed in
                            if (globalScale > 0.8 && node.x !== undefined && node.y !== undefined) {
                                const fontSize = 12 / globalScale;
                                ctx.font = `${fontSize}px Arial`;
                                
                                // Create a rich label
                                const name = node.name || node.label || node.id || 'Unnamed Node';
                                const type = node.type ? ` (${node.type})` : '';
                                const label = `${name}${type}`;
                                
                                // Draw text with background for better visibility
                                const textWidth = ctx.measureText(label).width;
                                const padding = 4;
                                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                                ctx.fillRect(
                                    node.x - textWidth/2 - padding,
                                    node.y + (node.val || 10) + fontSize - padding,
                                    textWidth + padding*2,
                                    fontSize + padding*2
                                );
                                
                                // Draw white text
                                ctx.fillStyle = '#ffffff';
                                ctx.textAlign = 'center';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(label, node.x, node.y + (node.val || 10) + fontSize);
                            }
                        } catch (err) {
                            console.warn('Error rendering node:', err);
                        }
                    })
                    (graphContainer);
                
                // Add zoom and center controls
                document.getElementById('zoom-in')?.addEventListener('click', () => {
                    memoryGraph.zoom(1.2);
                });
                
                document.getElementById('zoom-out')?.addEventListener('click', () => {
                    memoryGraph.zoom(0.8);
                });
                
                document.getElementById('center-graph')?.addEventListener('click', () => {
                    memoryGraph.zoomToFit(400, 20);
                });
                
                // Add node click handler to show summary
                memoryGraph.onNodeClick(node => {
                    if (node) {
                        const name = node.name || node.label || node.id || 'Unnamed Node';
                        const type = node.type ? ` (${node.type})` : '';
                        const summary = node.properties?.summary || node.summary || 'No summary available';
                        const properties = node.properties || {};
                        const propsStr = Object.entries(properties)
                            .filter(([key]) => key !== 'summary')
                            .map(([key, value]) => `${key}: ${value}`)
                            .join('\n');
                        
                        const message = `Node: ${name}${type}\n\nSummary: ${summary}\n\nProperties:\n${propsStr}`;
                        alert(message);
                    }
                });
                
                // Automatically zoom to fit on first render
                setTimeout(() => {
                    memoryGraph.zoomToFit(400, 20);
                }, 500);
                
            } catch (error) {
                console.error('Error rendering memory graph:', error);
                graphContainer.innerHTML = `
                    <div class="flex flex-col justify-center items-center h-full">
                        <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                        </div>
                        <p class="text-white text-lg font-medium mb-2">Error Rendering Graph</p>
                        <p class="text-gray-400 text-center max-w-md px-4">
                            An error occurred while rendering the graph. Please try again or contact support if the issue persists.
                        </p>
                    </div>
                `;
            }
        }

        // Add document summary handling
        const documentSummaryPanel = document.getElementById('document-summary-panel');
        const documentSummaryContent = document.getElementById('document-summary-content');
        const refreshSummaryBtn = document.getElementById('refresh-summary');

        // Function to display document summary
        function displayDocumentSummary(summary) {
            if (summary) {
                documentSummaryPanel.classList.remove('hidden');
                documentSummaryContent.innerHTML = `
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <p class="text-gray-700">${summary}</p>
                    </div>
                `;
            }
        }

        // Function to refresh summary
        async function refreshDocumentSummary() {
            if (!rawMarkdown) return;
            
            // Show loading state
            documentSummaryContent.innerHTML = `
                <div class="flex flex-col justify-center items-center h-full">
                    <div class="w-16 h-16 bg-primary-700 rounded-full flex items-center justify-center mb-4 animate-pulse">
                        <i class="fas fa-sync-alt text-white text-2xl"></i>
                    </div>
                    <p class="text-gray-600 text-lg font-medium mb-2">Generating Summary...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/generate_summary', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        markdown: rawMarkdown
                    })
                });
                
                if (!response.ok) throw new Error('Failed to generate summary');
                
                const data = await response.json();
                if (data.success && data.summary) {
                    displayDocumentSummary(data.summary);
                } else {
                    throw new Error('No summary generated');
                }
            } catch (error) {
                console.error('Error refreshing summary:', error);
                documentSummaryContent.innerHTML = `
                    <div class="flex flex-col justify-center items-center h-full">
                        <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center mb-4">
                            <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                        </div>
                        <p class="text-gray-600 text-lg font-medium mb-2">Error Generating Summary</p>
                        <p class="text-gray-400 text-center max-w-md px-4">
                            Failed to generate summary. Please try again.
                        </p>
                    </div>
                `;
            }
        }

        // Add event listener for refresh button
        refreshSummaryBtn?.addEventListener('click', refreshDocumentSummary);
    </script>
    
    <!-- Chuck Norris AI PRO Popup -->
    <div class="overlay" id="pro-overlay"></div>
    <div class="chuck-norris-pro-popup" id="chuck-norris-pro-popup">
        <h3>Chuck Norris Says:</h3>
        <p>"Chuck Norris doesn't need Pro Mode. He is the mode."</p>
        <button class="chuck-norris-pro-close" id="close-pro-popup" onclick="closeProPopup()">Got it!</button>
    </div>
</body>
</html>